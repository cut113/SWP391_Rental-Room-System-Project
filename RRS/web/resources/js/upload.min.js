$.fn.wvtupload=function(n){var i=$(this).attr("id"),f=!1,u,r,b;if((navigator.appVersion.indexOf("MSIE 6.")!=-1||navigator.appVersion.indexOf("MSIE 7.")!=-1||navigator.appVersion.indexOf("MSIE 8.")!=-1||navigator.appVersion.indexOf("MSIE 9.")!=-1)&&(f=!0),f){$(this).html("Trình duyệt không hỗ trợ tính năng upload ảnh. Xin bạn vui lòng sử dụng trình duyệt khác.");return}var o=!0,t=$.extend({theme:"default-theme",pluginFolder:"",fileSize:6,serverThumb:"",serverUpload:"",maxFiles:3,itemWidth:95,itemHeight:95,rotateActionName:"rotate/",rotate90ActionName:"rotate/90/",rotate180ActionName:"rotate/180/",rotate270ActionName:"rotate/270/",loadList:0,postId:0},n),s=function(){$("#"+i+" .upload-item").unbind("click");$("#"+i+" .working-upload-item").click(function(){$("#"+i+" .fileupload").click()})},y=function(){$("#"+i+" .upload-item .upload-item-delete").unbind("click");$("#"+i+" .upload-item .upload-item-delete").click(function(){if(confirm("Bạn có chắc chắn muốn xoá ảnh này?")){var r=$(this).parent().attr("rel"),u=nt($("#"+n.target).val(),r);$("#"+n.target).val(u);$(this).parent().remove();f?$("#"+i+" .working-upload-item").length==0&&($("#"+i).append(a),c()):$("#"+i+" .working-upload-item").length==0&&($("#"+i).append(l),s());$.post("/Image/Delete",{id:t.postId,filename:r,__RequestVerificationToken:n.token},function(){return})}});$("#"+i+" .upload-item .upload-item-rotate").unbind("click");$("#"+i+" .upload-item .upload-item-rotate").click(function(){var i=$(this).parent().attr("rel"),r="",u;i.indexOf(t.rotateActionName)==-1?r=t.rotate90ActionName+i:i.indexOf(t.rotate90ActionName)!=-1?r=t.rotate180ActionName+i.replace(t.rotate90ActionName,""):i.indexOf(t.rotate180ActionName)!=-1?r=t.rotate270ActionName+i.replace(t.rotate180ActionName,""):i.indexOf(t.rotate270ActionName)!=-1&&(r=i.replace(t.rotate270ActionName,""));u=tt($("#"+n.target).val(),i,r);$("#"+n.target).val(u);f?($(this).parent().find(".background").remove(),$(this).parent().append('<img class="background" src="'+t.serverThumb+"/"+r+'"/>'),$(this).parent().attr("rel",r)):($(this).parent().attr("style","background:url('"+t.serverThumb+"/"+r+"')  no-repeat scroll 0% 0%;background-color:transparent; background-size:  "+t.itemWidth+"px "+t.itemHeight+"px "),$(this).parent().attr("rel",r))})},h=function(n){var r=n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2);$("#"+i+" .working-upload-item").removeClass("upload-item-loading");n.indexOf("dothi")!=-1||n.indexOf("thumb")!=-1?$("#"+i+" .working-upload-item").attr("style","background:url('"+n+"')  no-repeat scroll 0% 0% / "+t.itemWidth+"px "+t.itemHeight+"px transparent;"):$("#"+i+" .working-upload-item").attr("style","background:url('"+t.serverThumb+"/"+r+"/"+n+"')  no-repeat scroll 0% 0%; background-color:transparent; background-size:  "+t.itemWidth+"px "+t.itemHeight+"px ");$("#"+i+" .working-upload-item").attr("rel",n);$("#"+i+" .working-upload-item").append(w);$("#"+i+" .working-upload-item").removeClass("working-upload-item").after(l);s();y()},p=function(n){$("#"+i+" .working-upload-item").removeClass("upload-item-loading");$("#postiframe").remove();$("#theuploadform").remove();$("#"+i+" .working-upload-item").append('<img class="background" src="'+t.serverThumb+"/"+n+'"/>');$("#"+i+" .working-upload-item").attr("rel",n);$("#"+i+" .working-upload-item").append(w);$("#"+i+" .working-upload-item").removeClass("working-upload-item").after(a);c();y()},k=function(file){if(file.size>eval(t.fileSize*1048576))return"Kích thước ảnh quá lớn. Dũng lượng ảnh phải nhỏ hơn "+t.fileSize+" Mb";var ext=file.name.split(".").pop().toLowerCase();return $.inArray(ext,["gif","png","jpg","jpeg"])==-1?"Không đúng định dạng ảnh cho phép (gif, png, jpg, jpeg)":""},d=function(i){var r="";h(i);r=v($("#"+n.target).val(),i);$("#"+n.target).val(r);i!=""&&$.post("/Image/Create",{id:t.postId,filename:i,__RequestVerificationToken:n.token},function(){return})},g=function(t){var i="";p(t);i=v($("#"+n.target).val(),t);$("#"+n.target).val(i)},c=function(){o=!0;$("#fileToUpload").on("change",function(){$("#theuploadform").submit()});$("#postiframe").load(function(){if(o)o=!1;else{var n=this.contentWindow.document.body.innerHTML.replace("<pre>","").replace("<\/pre>","").replace("<PRE>","").replace("<\/PRE>","");if(n=="error"){alert("Có lỗi xảy ra, xin bạn vui lòng upload lại ảnh");return}g(n);e()&&$("#"+i+" .working-upload-item").remove()}})},e=function(){var i=$("#"+n.target).val()==""?"":$("#"+n.target).val().split(",");return i.length>=t.maxFiles?!0:!1};$("#"+i).addClass(t.theme);var l='<div class="upload-item working-upload-item"><\/div>',a='<div class="upload-item working-upload-item"><iframe name="postiframe" id="postiframe" style="display: none"><\/iframe><form id="theuploadform" action="/UploadHandler.ashx" method="post" encoding="multipart/form-data" enctype="multipart/form-data" target="postiframe"><input multiple class="fileuploadie7" type="file" id="fileToUpload" name="userfile"/><\/form><\/div>',w='<a href="javascript:void(0)" class="upload-item-delete" title="Xóa ảnh"><img src="'+t.pluginFolder+'/images/blank.gif"/><\/a>';if(f)if($(this).append(a),$("#"+n.target).val()!=""){for(u=$("#"+n.target).val()==""?"":$("#"+n.target).val().split(","),r=0;r<u.length;r++)p(u[r]);e()&&$("#"+i+" .working-upload-item").remove()}else c();else if($(this).append('<input id="secleimg" multiple class="fileupload" type="file"  name="userfile"/>'),$(this).append(l),$("#"+n.target).val()!=""){for(u=$("#"+n.target).val()==""?"":$("#"+n.target).val().split(","),r=0;r<u.length;r++)h(u[r]);e()&&$("#"+i+" .working-upload-item").remove()}else s();var v=function(n,t){var r,i;if(n=="")return t;for(r=n.split(","),i=0;i<r.length;i++)if(t==r[i])return n;return n+","+t},nt=function(n,t){var r,u,i;if(n=="")return"";for(r=n.split(","),u="",i=0;i<r.length;i++)t!=r[i]&&(u+=(u!=""?",":"")+r[i]);return u.trim()},tt=function(n,t,i){var f,r,u;if(n=="")return"";for(f=n.split(","),r="",u=0;u<f.length;u++)r+=t!=f[u]?(r!=""?",":"")+f[u]:(r!=""?",":"")+i;return r.trim()};$("#"+i+" .fileupload").on("change",function(){var f,o,u;if(this.files.length>0)for(f=!1,r=0;r<this.files.length;r++){if(f)break;if(o=k(this.files[r]),o!=""){alert(o);continue}if(e()){alert("Bạn đã upload quá "+t.maxFiles+" ảnh");$("#"+i+" .working-upload-item").remove();break}u=new FormData;u.append("id","TTR");u.append("fileToUpload",this.files[r]);u.append("project","timnhatro");u.append("UploadType","upload");u.append("StringDecypt",n.token);u.append("submit","Upload Image");$.ajax({url:t.serverUpload+"/Image/Upload",type:"POST",data:u,cache:!1,dataType:"json",async:!1,processData:!1,contentType:!1,beforeSend:function(){$("#"+i+" .working-upload-item").addClass("upload-item-loading")},success:function(n){d(n)},error:function(){alert("Có lỗi xảy ra, xin bạn vui lòng upload lại ảnh");f=!0}})}e()&&$("#"+i+" .working-upload-item").remove()});b=function(){$.post("/Image/GetList",{id:t.postId},function(t){t.length>0&&$.each(t,function(t,i){h(i.Image);var r="";r=v($("#"+n.target).val(),i.Image);$("#"+n.target).val(r)})})};t.postId!=0&&b()}